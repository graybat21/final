/*
 * jQuery File Upload Plugin 5.40.1
 * https://github.com/blueimp/jQuery-File-Upload
 *
 * Copyright 2010, Sebastian Tschan
 * https://blueimp.net
 *
 * Licensed under the MIT license:
 * http://www.opensource.org/licenses/MIT
 */

/* jshint nomen:false */
/* global define, window, document, location, Blob, FormData */

(function(a){'use strict';if(typeof define==='function'&&define.amd){define(['jquery','jquery.ui.widget'],a)}else{a(window.jQuery)}}(function($){'use strict';$.support.fileInput=!(new RegExp('(Android (1\\.[0156]|2\\.[01]))'+'|(Windows Phone (OS 7|8\\.0))|(XBLWP)|(ZuneWP)|(WPDesktop)'+'|(w(eb)?OSBrowser)|(webOS)'+'|(Kindle/(1\\.0|2\\.[05]|3\\.0))').test(window.navigator.userAgent)||$('<input type="file">').prop('disabled'));$.support.xhrFileUpload=!!(window.ProgressEvent&&window.FileReader);$.support.xhrFormDataFileUpload=!!window.FormData;$.support.blobSlice=window.Blob&&(Blob.prototype.slice||Blob.prototype.webkitSlice||Blob.prototype.mozSlice);$.widget('blueimp.fileupload',{options:{dropZone:$(document),pasteZone:$(document),fileInput:undefined,replaceFileInput:true,paramName:undefined,singleFileUploads:true,limitMultiFileUploads:undefined,limitMultiFileUploadSize:undefined,limitMultiFileUploadSizeOverhead:512,sequentialUploads:false,limitConcurrentUploads:undefined,forceIframeTransport:false,redirect:undefined,redirectParamName:undefined,postMessage:undefined,multipart:true,maxChunkSize:undefined,uploadedBytes:undefined,recalculateProgress:true,progressInterval:100,bitrateInterval:500,autoUpload:true,messages:{uploadedBytes:'Uploaded bytes exceed file size'},i18n:function(c,d){c=this.messages[c]||c.toString();if(d){$.each(d,function(a,b){c=c.replace('{'+a+'}',b)})}return c},formData:function(a){return a.serializeArray()},add:function(e,a){if(e.isDefaultPrevented()){return false}if(a.autoUpload||(a.autoUpload!==false&&$(this).fileupload('option','autoUpload'))){a.process().done(function(){a.submit()})}},processData:false,contentType:false,cache:false},_specialOptions:['fileInput','dropZone','pasteZone','multipart','forceIframeTransport'],_blobSlice:$.support.blobSlice&&function(){var a=this.slice||this.webkitSlice||this.mozSlice;return a.apply(this,arguments)},_BitrateTimer:function(){this.timestamp=((Date.now)?Date.now():(new Date()).getTime());this.loaded=0;this.bitrate=0;this.getBitrate=function(a,b,c){var d=a-this.timestamp;if(!this.bitrate||!c||d>c){this.bitrate=(b-this.loaded)*(1000/d)*8;this.loaded=b;this.timestamp=a}return this.bitrate}},_isXHRUpload:function(a){return!a.forceIframeTransport&&((!a.multipart&&$.support.xhrFileUpload)||$.support.xhrFormDataFileUpload)},_getFormData:function(c){var d;if($.type(c.formData)==='function'){return c.formData(c.form)}if($.isArray(c.formData)){return c.formData}if($.type(c.formData)==='object'){d=[];$.each(c.formData,function(a,b){d.push({name:a,value:b})});return d}return[]},_getTotal:function(c){var d=0;$.each(c,function(a,b){d+=b.size||1});return d},_initProgressObject:function(a){var b={loaded:0,total:0,bitrate:0};if(a._progress){$.extend(a._progress,b)}else{a._progress=b}},_initResponseObject:function(a){var b;if(a._response){for(b in a._response){if(a._response.hasOwnProperty(b)){delete a._response[b]}}}else{a._response={}}},_onProgress:function(e,a){if(e.lengthComputable){var b=((Date.now)?Date.now():(new Date()).getTime()),loaded;if(a._time&&a.progressInterval&&(b-a._time<a.progressInterval)&&e.loaded!==e.total){return}a._time=b;loaded=Math.floor(e.loaded/e.total*(a.chunkSize||a._progress.total))+(a.uploadedBytes||0);this._progress.loaded+=(loaded-a._progress.loaded);this._progress.bitrate=this._bitrateTimer.getBitrate(b,this._progress.loaded,a.bitrateInterval);a._progress.loaded=a.loaded=loaded;a._progress.bitrate=a.bitrate=a._bitrateTimer.getBitrate(b,loaded,a.bitrateInterval);this._trigger('progress',$.Event('progress',{delegatedEvent:e}),a);this._trigger('progressall',$.Event('progressall',{delegatedEvent:e}),this._progress)}},_initProgressListener:function(b){var c=this,xhr=b.xhr?b.xhr():$.ajaxSettings.xhr();if(xhr.upload){$(xhr.upload).bind('progress',function(e){var a=e.originalEvent;e.lengthComputable=a.lengthComputable;e.loaded=a.loaded;e.total=a.total;c._onProgress(e,b)});b.xhr=function(){return xhr}}},_isInstanceOf:function(a,b){return Object.prototype.toString.call(b)==='[object '+a+']'},_initXHRData:function(c){var d=this,formData,file=c.files[0],multipart=c.multipart||!$.support.xhrFileUpload,paramName=$.type(c.paramName)==='array'?c.paramName[0]:c.paramName;c.headers=$.extend({},c.headers);if(c.contentRange){c.headers['Content-Range']=c.contentRange}if(!multipart||c.blob||!this._isInstanceOf('File',file)){c.headers['Content-Disposition']='attachment; filename="'+encodeURI(file.name)+'"'}if(!multipart){c.contentType=file.type||'application/octet-stream';c.data=c.blob||file}else if($.support.xhrFormDataFileUpload){if(c.postMessage){formData=this._getFormData(c);if(c.blob){formData.push({name:paramName,value:c.blob})}else{$.each(c.files,function(a,b){formData.push({name:($.type(c.paramName)==='array'&&c.paramName[a])||paramName,value:b})})}}else{if(d._isInstanceOf('FormData',c.formData)){formData=c.formData}else{formData=new FormData();$.each(this._getFormData(c),function(a,b){formData.append(b.name,b.value)})}if(c.blob){formData.append(paramName,c.blob,file.name)}else{$.each(c.files,function(a,b){if(d._isInstanceOf('File',b)||d._isInstanceOf('Blob',b)){formData.append(($.type(c.paramName)==='array'&&c.paramName[a])||paramName,b,b.uploadName||b.name)}})}}c.data=formData}c.blob=null},_initIframeSettings:function(a){var b=$('<a></a>').prop('href',a.url).prop('host');a.dataType='iframe '+(a.dataType||'');a.formData=this._getFormData(a);if(a.redirect&&b&&b!==location.host){a.formData.push({name:a.redirectParamName||'redirect',value:a.redirect})}},_initDataSettings:function(a){if(this._isXHRUpload(a)){if(!this._chunkedUpload(a,true)){if(!a.data){this._initXHRData(a)}this._initProgressListener(a)}if(a.postMessage){a.dataType='postmessage '+(a.dataType||'')}}else{this._initIframeSettings(a)}},_getParamName:function(b){var c=$(b.fileInput),paramName=b.paramName;if(!paramName){paramName=[];c.each(function(){var a=$(this),name=a.prop('name')||'files[]',i=(a.prop('files')||[1]).length;while(i){paramName.push(name);i-=1}});if(!paramName.length){paramName=[c.prop('name')||'files[]']}}else if(!$.isArray(paramName)){paramName=[paramName]}return paramName},_initFormSettings:function(a){if(!a.form||!a.form.length){a.form=$(a.fileInput.prop('form'));if(!a.form.length){a.form=$(this.options.fileInput.prop('form'))}}a.paramName=this._getParamName(a);if(!a.url){a.url=a.form.prop('action')||location.href}a.type=(a.type||($.type(a.form.prop('method'))==='string'&&a.form.prop('method'))||'').toUpperCase();if(a.type!=='POST'&&a.type!=='PUT'&&a.type!=='PATCH'){a.type='POST'}if(!a.formAcceptCharset){a.formAcceptCharset=a.form.attr('accept-charset')}},_getAJAXSettings:function(a){var b=$.extend({},this.options,a);this._initFormSettings(b);this._initDataSettings(b);return b},_getDeferredState:function(a){if(a.state){return a.state()}if(a.isResolved()){return'resolved'}if(a.isRejected()){return'rejected'}return'pending'},_enhancePromise:function(a){a.success=a.done;a.error=a.fail;a.complete=a.always;return a},_getXHRPromise:function(a,b,c){var d=$.Deferred(),promise=d.promise();b=b||this.options.context||promise;if(a===true){d.resolveWith(b,c)}else if(a===false){d.rejectWith(b,c)}promise.abort=d.promise;return this._enhancePromise(promise)},_addConvenienceMethods:function(e,c){var d=this,getPromise=function(a){return $.Deferred().resolveWith(d,a).promise()};c.process=function(a,b){if(a||b){c._processQueue=this._processQueue=(this._processQueue||getPromise([this])).pipe(function(){if(c.errorThrown){return $.Deferred().rejectWith(d,[c]).promise()}return getPromise(arguments)}).pipe(a,b)}return this._processQueue||getPromise([this])};c.submit=function(){if(this.state()!=='pending'){c.jqXHR=this.jqXHR=(d._trigger('submit',$.Event('submit',{delegatedEvent:e}),this)!==false)&&d._onSend(e,this)}return this.jqXHR||d._getXHRPromise()};c.abort=function(){if(this.jqXHR){return this.jqXHR.abort()}this.errorThrown='abort';d._trigger('fail',null,this);return d._getXHRPromise(false)};c.state=function(){if(this.jqXHR){return d._getDeferredState(this.jqXHR)}if(this._processQueue){return d._getDeferredState(this._processQueue)}};c.processing=function(){return!this.jqXHR&&this._processQueue&&d._getDeferredState(this._processQueue)==='pending'};c.progress=function(){return this._progress};c.response=function(){return this._response}},_getUploadedBytes:function(a){var b=a.getResponseHeader('Range'),parts=b&&b.split('-'),upperBytesPos=parts&&parts.length>1&&parseInt(parts[1],10);return upperBytesPos&&upperBytesPos+1},_chunkedUpload:function(d,e){d.uploadedBytes=d.uploadedBytes||0;var f=this,file=d.files[0],fs=file.size,ub=d.uploadedBytes,mcs=d.maxChunkSize||fs,slice=this._blobSlice,dfd=$.Deferred(),promise=dfd.promise(),jqXHR,upload;if(!(this._isXHRUpload(d)&&slice&&(ub||mcs<fs))||d.data){return false}if(e){return true}if(ub>=fs){file.error=d.i18n('uploadedBytes');return this._getXHRPromise(false,d.context,[null,'error',file.error])}upload=function(){var o=$.extend({},d),currentLoaded=o._progress.loaded;o.blob=slice.call(file,ub,ub+mcs,file.type);o.chunkSize=o.blob.size;o.contentRange='bytes '+ub+'-'+(ub+o.chunkSize-1)+'/'+fs;f._initXHRData(o);f._initProgressListener(o);jqXHR=((f._trigger('chunksend',null,o)!==false&&$.ajax(o))||f._getXHRPromise(false,o.context)).done(function(a,b,c){ub=f._getUploadedBytes(c)||(ub+o.chunkSize);if(currentLoaded+o.chunkSize-o._progress.loaded){f._onProgress($.Event('progress',{lengthComputable:true,loaded:ub-o.uploadedBytes,total:ub-o.uploadedBytes}),o)}d.uploadedBytes=o.uploadedBytes=ub;o.result=a;o.textStatus=b;o.jqXHR=c;f._trigger('chunkdone',null,o);f._trigger('chunkalways',null,o);if(ub<fs){upload()}else{dfd.resolveWith(o.context,[a,b,c])}}).fail(function(a,b,c){o.jqXHR=a;o.textStatus=b;o.errorThrown=c;f._trigger('chunkfail',null,o);f._trigger('chunkalways',null,o);dfd.rejectWith(o.context,[a,b,c])})};this._enhancePromise(promise);promise.abort=function(){return jqXHR.abort()};upload();return promise},_beforeSend:function(e,a){if(this._active===0){this._trigger('start');this._bitrateTimer=new this._BitrateTimer();this._progress.loaded=this._progress.total=0;this._progress.bitrate=0}this._initResponseObject(a);this._initProgressObject(a);a._progress.loaded=a.loaded=a.uploadedBytes||0;a._progress.total=a.total=this._getTotal(a.files)||1;a._progress.bitrate=a.bitrate=0;this._active+=1;this._progress.loaded+=a.loaded;this._progress.total+=a.total},_onDone:function(a,b,c,d){var e=d._progress.total,response=d._response;if(d._progress.loaded<e){this._onProgress($.Event('progress',{lengthComputable:true,loaded:e,total:e}),d)}response.result=d.result=a;response.textStatus=d.textStatus=b;response.jqXHR=d.jqXHR=c;this._trigger('done',null,d)},_onFail:function(a,b,c,d){var e=d._response;if(d.recalculateProgress){this._progress.loaded-=d._progress.loaded;this._progress.total-=d._progress.total}e.jqXHR=d.jqXHR=a;e.textStatus=d.textStatus=b;e.errorThrown=d.errorThrown=c;this._trigger('fail',null,d)},_onAlways:function(a,b,c,d){this._trigger('always',null,d)},_onSend:function(e,f){if(!f.submit){this._addConvenienceMethods(e,f)}var g=this,jqXHR,aborted,slot,pipe,options=g._getAJAXSettings(f),send=function(){g._sending+=1;options._bitrateTimer=new g._BitrateTimer();jqXHR=jqXHR||(((aborted||g._trigger('send',$.Event('send',{delegatedEvent:e}),options)===false)&&g._getXHRPromise(false,options.context,aborted))||g._chunkedUpload(options)||$.ajax(options)).done(function(a,b,c){g._onDone(a,b,c,options)}).fail(function(a,b,c){g._onFail(a,b,c,options)}).always(function(a,b,c){g._onAlways(a,b,c,options);g._sending-=1;g._active-=1;if(options.limitConcurrentUploads&&options.limitConcurrentUploads>g._sending){var d=g._slots.shift();while(d){if(g._getDeferredState(d)==='pending'){d.resolve();break}d=g._slots.shift()}}if(g._active===0){g._trigger('stop')}});return jqXHR};this._beforeSend(e,options);if(this.options.sequentialUploads||(this.options.limitConcurrentUploads&&this.options.limitConcurrentUploads<=this._sending)){if(this.options.limitConcurrentUploads>1){slot=$.Deferred();this._slots.push(slot);pipe=slot.pipe(send)}else{this._sequence=this._sequence.pipe(send,send);pipe=this._sequence}pipe.abort=function(){aborted=[undefined,'abort','abort'];if(!jqXHR){if(slot){slot.rejectWith(options.context,aborted)}return send()}return jqXHR.abort()};return this._enhancePromise(pipe)}return send()},_onAdd:function(e,d){var f=this,result=true,options=$.extend({},this.options,d),files=d.files,filesLength=files.length,limit=options.limitMultiFileUploads,limitSize=options.limitMultiFileUploadSize,overhead=options.limitMultiFileUploadSizeOverhead,batchSize=0,paramName=this._getParamName(options),paramNameSet,paramNameSlice,fileSet,i,j=0;if(limitSize&&(!filesLength||files[0].size===undefined)){limitSize=undefined}if(!(options.singleFileUploads||limit||limitSize)||!this._isXHRUpload(options)){fileSet=[files];paramNameSet=[paramName]}else if(!(options.singleFileUploads||limitSize)&&limit){fileSet=[];paramNameSet=[];for(i=0;i<filesLength;i+=limit){fileSet.push(files.slice(i,i+limit));paramNameSlice=paramName.slice(i,i+limit);if(!paramNameSlice.length){paramNameSlice=paramName}paramNameSet.push(paramNameSlice)}}else if(!options.singleFileUploads&&limitSize){fileSet=[];paramNameSet=[];for(i=0;i<filesLength;i=i+1){batchSize+=files[i].size+overhead;if(i+1===filesLength||((batchSize+files[i+1].size+overhead)>limitSize)||(limit&&i+1-j>=limit)){fileSet.push(files.slice(j,i+1));paramNameSlice=paramName.slice(j,i+1);if(!paramNameSlice.length){paramNameSlice=paramName}paramNameSet.push(paramNameSlice);j=i+1;batchSize=0}}}else{paramNameSet=paramName}d.originalFiles=files;$.each(fileSet||files,function(a,b){var c=$.extend({},d);c.files=fileSet?b:[b];c.paramName=paramNameSet[a];f._initResponseObject(c);f._initProgressObject(c);f._addConvenienceMethods(e,c);result=f._trigger('add',$.Event('add',{delegatedEvent:e}),c);return result});return result},_replaceFileInput:function(b){var c=b.clone(true);$('<form></form>').append(c)[0].reset();b.after(c).detach();$.cleanData(b.unbind('remove'));this.options.fileInput=this.options.fileInput.map(function(i,a){if(a===b[0]){return c[0]}return a});if(b[0]===this.element[0]){this.element=c}},_handleFileTreeEntry:function(c,d){var f=this,dfd=$.Deferred(),errorHandler=function(e){if(e&&!e.entry){e.entry=c}dfd.resolve([e])},dirReader;d=d||'';if(c.isFile){if(c._file){c._file.relativePath=d;dfd.resolve(c._file)}else{c.file(function(a){a.relativePath=d;dfd.resolve(a)},errorHandler)}}else if(c.isDirectory){dirReader=c.createReader();dirReader.readEntries(function(b){f._handleFileTreeEntries(b,d+c.name+'/').done(function(a){dfd.resolve(a)}).fail(errorHandler)},errorHandler)}else{dfd.resolve([])}return dfd.promise()},_handleFileTreeEntries:function(b,c){var d=this;return $.when.apply($,$.map(b,function(a){return d._handleFileTreeEntry(a,c)})).pipe(function(){return Array.prototype.concat.apply([],arguments)})},_getDroppedFiles:function(c){c=c||{};var d=c.items;if(d&&d.length&&(d[0].webkitGetAsEntry||d[0].getAsEntry)){return this._handleFileTreeEntries($.map(d,function(a){var b;if(a.webkitGetAsEntry){b=a.webkitGetAsEntry();if(b){b._file=a.getAsFile()}return b}return a.getAsEntry()}))}return $.Deferred().resolve($.makeArray(c.files)).promise()},_getSingleFileInputFiles:function(c){c=$(c);var d=c.prop('webkitEntries')||c.prop('entries'),files,value;if(d&&d.length){return this._handleFileTreeEntries(d)}files=$.makeArray(c.prop('files'));if(!files.length){value=c.prop('value');if(!value){return $.Deferred().resolve([]).promise()}files=[{name:value.replace(/^.*\\/,'')}]}else if(files[0].name===undefined&&files[0].fileName){$.each(files,function(a,b){b.name=b.fileName;b.size=b.fileSize})}return $.Deferred().resolve(files).promise()},_getFileInputFiles:function(a){if(!(a instanceof $)||a.length===1){return this._getSingleFileInputFiles(a)}return $.when.apply($,$.map(a,this._getSingleFileInputFiles)).pipe(function(){return Array.prototype.concat.apply([],arguments)})},_onChange:function(e){var b=this,data={fileInput:$(e.target),form:$(e.target.form)};this._getFileInputFiles(data.fileInput).always(function(a){data.files=a;if(b.options.replaceFileInput){b._replaceFileInput(data.fileInput)}if(b._trigger('change',$.Event('change',{delegatedEvent:e}),data)!==false){b._onAdd(e,data)}})},_onPaste:function(e){var d=e.originalEvent&&e.originalEvent.clipboardData&&e.originalEvent.clipboardData.items,data={files:[]};if(d&&d.length){$.each(d,function(a,b){var c=b.getAsFile&&b.getAsFile();if(c){data.files.push(c)}});if(this._trigger('paste',$.Event('paste',{delegatedEvent:e}),data)!==false){this._onAdd(e,data)}}},_onDrop:function(e){e.dataTransfer=e.originalEvent&&e.originalEvent.dataTransfer;var b=this,dataTransfer=e.dataTransfer,data={};if(dataTransfer&&dataTransfer.files&&dataTransfer.files.length){e.preventDefault();this._getDroppedFiles(dataTransfer).always(function(a){data.files=a;if(b._trigger('drop',$.Event('drop',{delegatedEvent:e}),data)!==false){b._onAdd(e,data)}})}},_onDragOver:function(e){e.dataTransfer=e.originalEvent&&e.originalEvent.dataTransfer;var a=e.dataTransfer;if(a&&$.inArray('Files',a.types)!==-1&&this._trigger('dragover',$.Event('dragover',{delegatedEvent:e}))!==false){e.preventDefault();a.dropEffect='copy'}},_initEventHandlers:function(){if(this._isXHRUpload(this.options)){this._on(this.options.dropZone,{dragover:this._onDragOver,drop:this._onDrop});this._on(this.options.pasteZone,{paste:this._onPaste})}if($.support.fileInput){this._on(this.options.fileInput,{change:this._onChange})}},_destroyEventHandlers:function(){this._off(this.options.dropZone,'dragover drop');this._off(this.options.pasteZone,'paste');this._off(this.options.fileInput,'change')},_setOption:function(a,b){var c=$.inArray(a,this._specialOptions)!==-1;if(c){this._destroyEventHandlers()}this._super(a,b);if(c){this._initSpecialOptions();this._initEventHandlers()}},_initSpecialOptions:function(){var a=this.options;if(a.fileInput===undefined){a.fileInput=this.element.is('input[type="file"]')?this.element:this.element.find('input[type="file"]')}else if(!(a.fileInput instanceof $)){a.fileInput=$(a.fileInput)}if(!(a.dropZone instanceof $)){a.dropZone=$(a.dropZone)}if(!(a.pasteZone instanceof $)){a.pasteZone=$(a.pasteZone)}},_getRegExp:function(a){var b=a.split('/'),modifiers=b.pop();b.shift();return new RegExp(b.join('/'),modifiers)},_isRegExpOption:function(a,b){return a!=='url'&&$.type(b)==='string'&&/^\/.*\/[igm]{0,3}$/.test(b)},_initDataAttributes:function(){var d=this,options=this.options,clone=$(this.element[0].cloneNode(false));$.each(clone.data(),function(a,b){var c='data-'+a.replace(/([a-z])([A-Z])/g,'$1-$2').toLowerCase();if(clone.attr(c)){if(d._isRegExpOption(a,b)){b=d._getRegExp(b)}options[a]=b}})},_create:function(){this._initDataAttributes();this._initSpecialOptions();this._slots=[];this._sequence=this._getXHRPromise(true);this._sending=this._active=0;this._initProgressObject(this);this._initEventHandlers()},active:function(){return this._active},progress:function(){return this._progress},add:function(b){var c=this;if(!b||this.options.disabled){return}if(b.fileInput&&!b.files){this._getFileInputFiles(b.fileInput).always(function(a){b.files=a;c._onAdd(null,b)})}else{b.files=$.makeArray(b.files);this._onAdd(null,b)}},send:function(e){if(e&&!this.options.disabled){if(e.fileInput&&!e.files){var f=this,dfd=$.Deferred(),promise=dfd.promise(),jqXHR,aborted;promise.abort=function(){aborted=true;if(jqXHR){return jqXHR.abort()}dfd.reject(null,'abort','abort');return promise};this._getFileInputFiles(e.fileInput).always(function(d){if(aborted){return}if(!d.length){dfd.reject();return}e.files=d;jqXHR=f._onSend(null,e).then(function(a,b,c){dfd.resolve(a,b,c)},function(a,b,c){dfd.reject(a,b,c)})});return this._enhancePromise(promise)}e.files=$.makeArray(e.files);if(e.files.length){return this._onSend(null,e)}}return this._getXHRPromise(false,e&&e.context)}})}));